# Kafka Consumers

Ruby consumers for handling chat messages, geo location updates, tricking
searches in [storage](../storage):

- [Bulkdata](lib/kafka_consumers/bulkdata.rb) which handles bulk update to
  events generated by the [offerserver](../offerserver). These bulk update
  events then trigger a search action on the [storage](../storage) server.
- [ChatBot](lib/kafka_consumers/chatbot.rb) which provides chat interaction
  for messages sent to offers created by the [offerserver](../offerserver).
  Since those offers don't have a "human" creator, there is no one available
  to provide chat information, so this consumer does that.
- [Geo Updater](lib/kafka_consumers/geo.rb) which triggers a search refresh
  on the [storage](../storage) server which new geo locations for a user
  are generated.
- [GeoNames](lib/kafka_consumers/geonames.rb) is a consumer that generates
  offers on-the-fly by searching [GeoNames](https://www.geonames.org/).
  These offers then become available when another (or the same user) repeats
  the search.
- [Notifier](lib/kafka_consumers/notifier.rb) retriggers match generation
  when offers or searches get updated by users.

All consumers are managed by [Sidekiq](https://sidekiq.org/) and are
basically reoccuring [cron jobs](config/initializers/sidekiq.rb#L8-L39).

## Local testing

To test locally, you'll need to start kafka, zookeeper and redis

    # redis
    eval $(cat .env) ; docker-compose -f docker-compose/consumers.ruby.yml up ruby-consumers-db

    # kafka & zookeeper
    eval $(cat .env) ; docker-compose -f docker-compose/kafka-zookeeper.yml up

    # start ruby shell
    rake shell

that's about it.
