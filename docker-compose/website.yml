version: '2'
services:
  pgwebsite:
    image: postgres:9.6.6
    restart: always
    environment:
      - POSTGRES_PASSWORD=nicesecret
    ports:
      - "5432"
    volumes:
      - websitedb:/var/lib/postgresql/data

  website:
    build: ../src/website
    ports:
      - "$WEBSITE_PORT:$WEBSITE_PORT"
    command: "/bin/bash -c 'rake docker:pause_for_db      && \
                            rake docker:if_db_is_migrated && \
                            rake appjson:to_dotenv        && \
                            foreman start web'"
    links:
      - pgwebsite
    environment:
      - RACK_ENV=development
      - PORT=$WEBSITE_PORT
      - DATABASE_URL=postgres://postgres:nicesecret@pgwebsite:5432/webs
      - DOCKER_ENV_STORE=/var/lib/website/env
      - ASSETS_HOST=http://imageserver:$IMAGE_SERVER_PORT
      - PROFILE_HOST=https://profile.pushtech.de
      - LOGIN_HOST=website:$WEBSITE_PORT
      - CDN_HOSTS=localhost:$WEBSITE_PORT,localhost:$WEBSITE_PORT
      - NOTIFIER_HOST=http://notificationserver:$NOTIFICATION_SERVER_PORT
      - GOOGLE_API_KEY=$GOOGLE_API_KEY
      - MANDRILL_API_KEY=$MANDRILL_API_KEY
      - PUSHTECH_API_USER=$PUSHTECH_API_USER
      - PUSHTECH_API_PASSWORD=$PUSHTECH_API_PASSWORD
      - PUSHTECH_API_HOST=http://storage:$STORAGE_PORT
      - SENDBIRD_API_TOKEN=$SENDBIRD_API_TOKEN
      - SENDBIRD_API_ID=$SENDBIRD_API_ID
      - TRACKING_HOST=http://tracker:$TRACKER_PORT
      - DB_POOL_SIZE=20
      - DB_TIMEOUT_MSEC=5000
    volumes:
      - websiteenv:/var/lib/website/env
    restart: always

  website-migrate-db:
    build: ../src/website
    command: "/bin/bash -c 'rake docker:pause_for_db               && \
                            rake docker:if_db_not_migrated         && \
                            rake db:create                         && \
                            rake docker:create_postgres_extensions && \
                            rake db:migrate'"
    links:
      - pgwebsite
    environment:
      - RACK_ENV=production
      - DATABASE_URL=postgres://postgres:nicesecret@pgwebsite:5432/webs
    restart: "no"

networks:
  default:
    external:
      name: thenetwork

volumes:
  websitedb:
    external: true
  websiteenv:
    external: true
